# OPTIMIZED BUILD CONFIGURATION v2
# Backups: nixpacks.toml.backup (original), nixpacks.toml.backup2 (after first optimization)
# To revert: cp nixpacks.toml.backup2 nixpacks.toml

[phases.setup]
# Node.js 20 required for @vercel/blob and pdf-parse
nixPkgs = ["nodejs_20", "npm"]

[phases.install]
cmds = [
  "npm ci"
]

[phases.build]
# Explicitly depend on install phase to prevent Nixpacks from auto-adding yarn install
dependsOn = ["install"]
cmds = [
  # Generate Prisma client (must run first)
  "npx prisma generate --schema=./packages/database/prisma/schema.prisma",
  # Build database package first (Prisma client dependency)
  "cd packages/database && npm run build && cd ../..",
  # Build independent packages in PARALLEL using background jobs
  "(cd packages/ai-client && npm run build) & (cd packages/prompt-client && npm run build) & (cd packages/utils && npm run build) & wait",
  # Build the API gateway service with production TypeScript config
  "cd services/api-gateway && npx tsc --project ../../tsconfig.production.json && cd ../.."
]

[start]
cmd = "cd services/api-gateway && node dist/services/api-gateway/src/index.js"
